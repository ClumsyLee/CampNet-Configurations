ssids:
  - Tsinghua
  - Tsinghua-5G

# https://usereg.tsinghua.edu.cn/help.htm
billings:
  student:
    max_online_num: 3
    base: 0
    cycle: month
    steps:
      - [20, 1]
      - [30, 2]
      - [40, 3]
      - [50, 5]
  staff:
    max_online_num: 3
    base: 12
    cycle: month
    steps:
      - [20, 1]
      - [30, 2]
      - [40, 3]
      - [50, 5]
  temporary:
    max_online_num: 1
    base: 10
    cycle: day
    steps:
      - [2, 5]
  leaver:
    max_online_num: 0

# Default vars:
# - username
# - password
# - password.md5
actions:
  login:
    - method: POST
      url: http://net.tsinghua.edu.cn/do_login.php
      params:
        action: login
        username: "{username}"
        password: "{MD5_HEX}{password.md5}"
        ac_id: "1"
      script: |
        if (resp != "Login is successful." && resp != "IP has been online, please logout.") {
            let matches = /E([\d]+)/.exec(resp);

            let n = NaN;
            if (matches)
                n = Number(matches[1]);

            switch (n) {
                case 2531: throw Error("unauthorized.username");
                case 2553: throw Error("unauthorized.password");
                case 2616:
                case 3001:
                case 3004: throw Error("arrears");
                default: throw Error("unknown");
            }
        }

  # Expected vars:
  # - status (online | offline | offcampus) (*)
  # - online_username
  # - start_time
  # - usage
  status:
    - url: http://net.tsinghua.edu.cn/rad_user_info.php
      script: |
        if (!resp) {
            vars.status = "offline"
        } else {
            let info = resp.split(",");

            vars.status = "onlisne"
            vars.online_username = info[0];
            vars.start_time = new Date(Number(info[1]) * 1000);
            vars.usage = Number(info[3]);
        }

  # Expected vars:
  # - balance (*)
  # - billing
  # - name
  # - usage
  # - custom_max_online_num
  # - sessions
  #   - ip (*)
  #   - id
  #   - start_time
  #   - usage
  #   - mac
  #   - device
  profile:
    - method: POST
      url: http://usereg.tsinghua.edu.cn/do.php
      params:
        action: login
        user_login_name: "{username}"
        user_password: "{password.md5}"
      script: |
        if (resp != "ok") {
            switch (resp) {
                case "用户不存在": throw Error("unauthorized.username");
                case "密码错误": throw Error("unauthorized.password");
                default: throw Error("unknown");
            }
        }

    - url: http://usereg.tsinghua.edu.cn/user_info.php
      vars:
        balance: number(substring-before((//td[@class="maintd"])[34], "元"))
        billing: (//td[@class="maintd"])[4]
        name: (//td[@class="maintd"])[6]
        usage: number(substring-before((//td[@class="maintd"])[26], "("))
      script: |
        switch (vars.billing) {
            case "在校生": vars.billing = "student"; break;
            case "离校学生": vars.billing = "leaver"; break;
            default: throw Error("unauthorized.billing");
        }

    - url: http://usereg.tsinghua.edu.cn/modify_online_num.php
      vars:
        custom_max_online_num: number(//option[@selected]/@value)
      script: |
        if (resp == "您已经离校，无操作权限")
            vars.custom_max_online_num = 0;

    - url: http://usereg.tsinghua.edu.cn/online_user_ipv4.php
      vars:
        ids: //tr[position()>=2]//input/@value
        ips: //tr[position()>=2]/td[2]
        start_times: //tr[position()>=2]/td[3]
        usages: //tr[position()>=2]/td[4]
        macs: //tr[position()>=2]/td[8]
        devices: //tr[position()>=2]/td[12]
      script: |
        vars.sessions = [];

        for (let i = 0; i < vars.ips.length; i++) {
            let usage = vars.usages[i];
            let num = Number(usage.substr(0, usage.length - 1));
            let unit = usage[usage.length - 1].toUpperCase();

            let ratio = 1;
            switch (unit) {
              case 'K': ratio = 1e3; break;  // TODO: Confirm.
              case 'M': ratio = 1e6; break;
              case 'G': ratio = 1e9; break;
            }

            usage = Math.round(num * ratio);

            vars.sessions.push({
                id: vars.ids[i],
                ip: vars.ips[i],
                start_time: new Date(vars.start_times[i].replace(' ', 'T') + '+08:00'),
                usage: usage,
                mac: macs[i],
                device: devices[i]
            });
        }

  # Extra vars:
  # - new_value
  modify_custom_max_online_num:
    - method: POST
      url: http://usereg.tsinghua.edu.cn/do.php
      params:
        action: login
        user_login_name: "{username}"
        user_password: "{password.md5}"
      script: |
        if (resp != "ok") {
            switch (resp) {
                case "用户不存在": throw Error("unauthorized.username");
                case "密码错误": throw Error("unauthorized.password");
                default: throw Error("unknown");
            }
        }

    - method: POST
      url: http://usereg.tsinghua.edu.cn/modify_online_num.php
      params:
        action: mod
        user_max_online_num: "{new_value}"
      script: |
        if (resp != "联网数已修改")
            throw Error("unknown");

  # Extra vars:
  # - ip
  login_ip:
    - method: POST
      url: http://usereg.tsinghua.edu.cn/do.php
      params:
        action: login
        user_login_name: "{username}"
        user_password: "{password.md5}"
      script: |
        if (resp != "ok") {
            switch (resp) {
                case "用户不存在": throw Error("unauthorized.username");
                case "密码错误": throw Error("unauthorized.password");
                default: throw Error("unknown");
            }
        }

    - method: POST
      url: http://usereg.tsinghua.edu.cn/ip_login.php
      params:
        n: "100"
        is_pad: "1"
        type: "10"
        action: do_login
        user_ip: "{ip}"
        drop: "0"
      script: |
        if (resp != "上线请求已发送")
            throw Error("unknown");

  # Extra vars:
  # - ip
  # - id
  logout_session:
    - method: POST
      url: http://usereg.tsinghua.edu.cn/do.php
      params:
        action: login
        user_login_name: "{username}"
        user_password: "{password.md5}"
      script: |
        if (resp != "ok") {
            switch (resp) {
                case "用户不存在": throw Error("unauthorized.username");
                case "密码错误": throw Error("unauthorized.password");
                default: throw Error("unknown");
            }
        }

    - method: POST
      url: http://usereg.tsinghua.edu.cn/online_user_ipv4.php
      params:
        action: drops
        user_ip: "{id},"
      script: |
        if (resp != "下线请求已发送")
            throw Error("unknown");

  # Extra vars:
  # - start_time.year
  # - start_time.month
  # - start_time.day
  # - end_time.year
  # - end_time.month
  # - end_time.day
  #
  # Expected vars:
  # - sessions
  #   - ip (*)
  #   - start_time (*)
  #   - end_time (*)
  #   - usage
  #   - cost
  #   - mac
  #   - device
  history:
    - method: POST
      url: http://usereg.tsinghua.edu.cn/do.php
      params:
        action: login
        user_login_name: "{username}"
        user_password: "{password.md5}"
      script: |
        if (resp != "ok") {
            switch (resp) {
                case "用户不存在": throw Error("unauthorized.username");
                case "密码错误": throw Error("unauthorized.password");
                default: throw Error("unknown");
            }
        }

    - url: http://usereg.tsinghua.edu.cn/user_detail_list.php
      params:
        action: query
        start_time: "{start_time.year}-{start_time.month}-{start_time.day}"
        end_time: "{end_time.year}-{start_time.month}-{start_time.day}"
        offset: "1000000000"
      vars:
        ips: //tr[position()>=2]/td[2]
        start_times: //tr[position()>=2]/td[3]
        end_times: //tr[position()>=2]/td[4]
        usages: //tr[position()>=2]/td[6]
        costs: //tr[position()>=2]/td[8]
        macs: //tr[position()>=2]/td[10]
        devices: //tr[position()>=2]/comment()[last()]
      script: |
        vars.sessions = [];

        for (let i = 0; i < vars.ips.length; i++) {
            let usage = vars.usages[i];
            let num = Number(usage.substr(0, usage.length - 1));
            let unit = usage[usage.length - 1].toUpperCase();

            let ratio = 1;
            switch (unit) {
              case 'K': ratio = 1e3; break;  // TODO: Confirm.
              case 'M': ratio = 1e6; break;
              case 'G': ratio = 1e9; break;
            }

            usage = Math.round(num * ratio);

            vars.sessions.push({
                ip: vars.ips[i],
                start_time: new Date(vars.start_times[i].replace(' ', 'T') + '+08:00'),
                end_time: new Date(vars.end_times[i].replace(' ', 'T') + '+08:00'),
                usage: usage,
                cost: Number(vars.costs[i]),
                mac: macs[i],
                device: devices[i]
            });
        }

  logout:
    - method: POST
      url: http://net.tsinghua.edu.cn/do_login.php
      params:
        action: logout
      script: |
        if (resp != "Logout is successful." && resp != "You are not online.")  # TODO: Confirm.
            throw Error("unknown");
            }
        }
