ssids:
  - Tsinghua
  - Tsinghua-5G

# https://usereg.tsinghua.edu.cn/help.htm
billing_groups:
  student:
    max_online_num: 3
    base: 0
    cycle: month
    steps:
      - [20, 1]
      - [30, 2]
      - [40, 3]
      - [50, 5]
  staff:
    max_online_num: 3
    base: 12
    cycle: month
    steps:
      - [20, 1]
      - [30, 2]
      - [40, 3]
      - [50, 5]
  temporary:
    max_online_num: 1
    base: 10
    cycle: day
    steps:
      - [2, 5]
  leaver:
    max_online_num: 0

# Default vars:
# - username
# - password
# - password.md5
actions:
  login:
    - method: POST
      url: http://net.tsinghua.edu.cn/do_login.php
      params:
        action: login
        username: "{username}"
        password: "{MD5_HEX}{password.md5}"
        ac_id: "1"
      script: |
        if (resp != "Login is successful." && resp != "IP has been online, please logout.") {
            let matches = /E([\d]+)/.exec(resp);

            let n = NaN;
            if (matches)
                n = Number(matches[1]);

            switch (n) {
                case 2531:
                case 2553: throw "unauthorized";
                case 2616:
                case 3001:
                case 3004: throw "arrears";
                default: throw "unknown";
            }
        }

  # Expected vars:
  # - status (online | offline | offcampus) (*)
  # - online_username
  # - start_time
  # - usage
  status:
    - url: http://net.tsinghua.edu.cn/rad_user_info.php
      script: |
        if (!resp) {
            vars.status = "offline"
        } else {
            let info = resp.split(",");

            vars.status = "online"
            vars.online_username = info[0];
            vars.start_time = new Date(Number(info[1]) * 1000);
            vars.usage = Number(info[3]);
        }

  # Expected vars:
  # - name
  # - billing_group_name
  # - balance
  # - usage
  # - custom_max_online_num
  # - ips (*)
  # - ids
  # - start_times
  # - usages
  # - macs
  # - devices
  profile:
    - method: POST
      url: http://usereg.tsinghua.edu.cn/do.php
      params:
        action: login
        user_login_name: "{username}"
        user_password: "{password_md5}"
      script: |
        if (resp != "ok") {
            switch (resp) {
                case "用户不存在":
                case "密码错误": throw "unauthorized";
                default: throw "unknown";
            }
        }

    - url: http://usereg.tsinghua.edu.cn/user_info.php
      vars:
        balance: (//td[@class="maintd"])[34]
        billing_group_name: (//td[@class="maintd"])[4]
        name: (//td[@class="maintd"])[6]
        usage: (//td[@class="maintd"])[26]
      script: |
        vars.balance = Number(vars.balance.substring(0, vars.balance.indexOf("元")));
        switch (vars.billing_group_name) {
            case "在校生": vars.billing_group_name = "student"; break;
            case "离校学生": vars.billing_group_name = "leaver"; break;
        }
        vars.usage = Number(vars.usage.substring(0, vars.usage.indexOf("(")));

    - url: http://usereg.tsinghua.edu.cn/modify_online_num.php
      vars:
        custom_max_online_num: //option[@selected]/@value

    - url: http://usereg.tsinghua.edu.cn/online_user_ipv4.php
      vars:
        ips[]: //tr[position()>=2]/td[2]
        ids[]: //tr[position()>=2]//input/@value
        start_times[]: //tr[position()>=2]/td[3]
        usages[]: //tr[position()>=2]/td[4]
        macs[]: //tr[position()>=2]/td[8]
        devices[]: //tr[position()>=2]/td[12]
      script: |
        vars.sessions = [];

        for (let i = 0; i < vars.ips.length; i++) {

            let usage = vars.usages[i];
            let num = Number(usage.substr(0, usage.length - 1));
            let unit = usage[usage.length - 1].toUpperCase();

            let ratio = 1;
            switch (unit) {
              case 'K': ratio = 1e3; break;  // TODO: Confirm.
              case 'M': ratio = 1e6; break;
              case 'G': ratio = 1e9; break;
            }

            usage = Math.round(num * ratio);

            vars.start_times[i] = new Date(vars.start_times[i].replace(' ', 'T') + '+08:00')
            vars.usages[i] = usage;
        }

  # Extra vars:
  # - new_value
  modify_custom_max_online_num:
    - method: POST
      url: http://usereg.tsinghua.edu.cn/do.php
      params:
        action: login
        user_login_name: "{username}"
        user_password: "{password_md5}"
      script: |
        if (resp != "ok") {
            switch (resp) {
                case "用户不存在":
                case "密码错误": throw "unauthorized";
                default: throw "unknown";
            }
        }

    - method: POST
      url: http://usereg.tsinghua.edu.cn/modify_online_num.php
      params:
        action: mod
        user_max_online_num: "{new_value}"
      script: |
        if (resp != "联网数已修改")
            throw "unknown";

  # Extra vars:
  # - ip
  login_ip:
    - method: POST
      url: http://usereg.tsinghua.edu.cn/do.php
      params:
        action: login
        user_login_name: "{username}"
        user_password: "{password_md5}"
      script: |
        if (resp != "ok") {
            switch (resp) {
                case "用户不存在":
                case "密码错误": throw "unauthorized";
                default: throw "unknown";
            }
        }

    - method: POST
      url: http://usereg.tsinghua.edu.cn/ip_login.php
      params:
        n: "100"
        is_pad: "1"
        type: "10"
        action: do_login
        user_ip: "{ip}"
        drop: "0"
      script: |
        if (resp != "上线请求已发送")
            throw "unknown";

  # Extra vars:
  # - ip
  # - id
  logout_session:
    - method: POST
      url: http://usereg.tsinghua.edu.cn/do.php
      params:
        action: login
        user_login_name: "{username}"
        user_password: "{password_md5}"
      script: |
        if (resp != "ok") {
            switch (resp) {
                case "用户不存在":
                case "密码错误": throw "unauthorized";
                default: throw "unknown";
            }
        }

    - method: POST
      url: http://usereg.tsinghua.edu.cn/online_user_ipv4.php
      params:
        action: drops
        user_ip: "{id},"
      script: |
        if (resp != "下线请求已发送")
            throw "unknown";

  # Extra vars:
  # - start_time.year
  # - start_time.month
  # - start_time.day
  # - end_time.year
  # - end_time.month
  # - end_time.day
  #
  # Expected vars:
  # - ips (*)
  # - start_times (*)
  # - end_times (*)
  # - usages
  # - costs
  # - macs
  # - devices
  history:
    - method: POST
      url: http://usereg.tsinghua.edu.cn/do.php
      params:
        action: login
        user_login_name: "{username}"
        user_password: "{password_md5}"
      script: |
        if (resp != "ok") {
            switch (resp) {
                case "用户不存在":
                case "密码错误": throw "unauthorized";
                default: throw "unknown";
            }
        }

    - url: http://usereg.tsinghua.edu.cn/user_detail_list.php
      params:
        action: query
        start_time: "{start_time.year}-{start_time.month}-{start_time.day}"
        end_time: "{end_time.year}-{start_time.month}-{start_time.day}"
        offset: "1000000000"
      vars:
        ips[]: //tr[position()>=2]/td[2]
        start_times[]: //tr[position()>=2]/td[3]
        end_times[]: //tr[position()>=2]/td[4]
        usages[]: //tr[position()>=2]/td[6]
        costs[]: //tr[position()>=2]/td[8]
        macs[]: //tr[position()>=2]/td[10]
        devices[]: //tr[position()>=2]/comment()[last()]
      script: |
        vars.sessions = [];

        for (let i = 0; i < vars.ips.length; i++) {
            let usage = vars.usages[i];
            let num = Number(usage.substr(0, usage.length - 1));
            let unit = usage[usage.length - 1].toUpperCase();

            let ratio = 1;
            switch (unit) {
              case 'K': ratio = 1e3; break;  // TODO: Confirm.
              case 'M': ratio = 1e6; break;
              case 'G': ratio = 1e9; break;
            }

            usage = Math.round(num * ratio);

            vars.start_times[i] = new Date(vars.start_times[i].replace(' ', 'T') + '+08:00')
            vars.end_times[i] = new Date(vars.end_times[i].replace(' ', 'T') + '+08:00')
            vars.usages[i] = usage;
            vars.costs[i] = Number(vars.costs[i]);
        }

  logout:
    - method: POST
      url: http://net.tsinghua.edu.cn/do_login.php
      params:
        action: logout
      script: |
        if (resp != "Logout is successful." && resp != "You are not online.")  # TODO: Confirm.
            throw "unknown";
